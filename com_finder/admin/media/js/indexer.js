
var FinderProgressBar=new Class({options:{container:$$('body')[0],boxID:'',percentageID:'',displayID:'',startPercentage:0,displayText:false,speed:10},initialize:function(options){this.setOptions(options);this.createElements();},createElements:function(){var box=new Element('div',{id:this.options.boxID});var perc=new Element('div',{id:this.options.percentageID,'style':'width:0px;'});perc.inject(box);box.inject(this.options.container);if(this.options.displayText){var text=new Element('div',{id:this.options.displayID});text.injectInside(this.options.container);}
this.set(this.options.startPercentage);},calculate:function(percentage){return($(this.options.boxID).getStyle('width').replace('px','')*(percentage/100)).toInt();},animate:function(to){var myEffect=$(this.options.percentageID).effects({duration:this.options.speed});myEffect.start({'width':this.calculate(to.toInt())});if(this.options.displayText){$(this.options.displayID).setText(to.toInt()+'%');}},set:function(to){this.animate(to);}});FinderProgressBar.implement(new Options);var FinderIndexer=new Class({totalItems:null,batchSize:null,offset:null,progress:null,optimized:false,path:'index.php?option=com_finder&tmpl=component&format=json&protocol=json',ajax:null,initialize:function(){this.offset=0;this.progress=0;this.pb=new FinderProgressBar({container:$('finder-progress-container'),startPercentage:0,speed:600,boxID:'finder-progress-box',percentageID:'finder-progress-perc',displayID:'finder-progress-status',displayText:true});this.ajax=new Ajax(this.path,{method:'get',data:$('finder-indexer-token').getProperty('name')+"=1&task=indexer.start",evalScripts:true});this.ajax.addEvent('onComplete',this.handleResponse.bind(this));this.ajax.addEvent('onFailure',this.handleResponse.bind(this));this.ajax.request()},handleResponse:function(resp){json=Json.evaluate(resp,true);if(json)$('finder-indexer-token').setProperty('name',json.token);if(json==null||json.error==true){if(this.pb)$(this.pb.options.container).remove();if(!json){json=$chk(resp.responseText)?Json.evaluate(resp.responseText,true):null;}
var header=json?json.header:'An Error Has Occurred';var message=json?json.message:'The following message was returned by the server: <br />'+resp
$('finder-progress-header').setText(header).addClass('finder-error');$('finder-progress-message').setHTML(message).addClass('finder-error');}else{if(json.start)this.totalItems=json.totalItems;this.offset+=json.batchOffset;this.updateProgress(json.header,json.message);if(this.offset<this.totalItems){this.ajax.setOptions({data:json.token+"=1&task=indexer.batch"});this.ajax.request();}
else if(!this.optimized){this.optimized=true;this.ajax.setOptions({data:json.token+"=1&task=indexer.optimize"});this.ajax.request();}}},updateProgress:function(header,message){this.progress=(this.offset/this.totalItems)*100;$('finder-progress-header').setText(header);$('finder-progress-message').setHTML(message);if(this.pb&&this.progress<100){this.pb.set(this.progress);}
else if(this.pb){$(this.pb.options.container).remove();this.pb=false;}}});window.addEvent('domready',function(){Indexer=new FinderIndexer();if(typeof window.parent.SqueezeBox=='object'){window.parent.SqueezeBox.addEvent('onClose',function(){Indexer.ajax.cancel();window.parent.location.reload(true);});}});